#‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø
#‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚£ø
#‚£ø‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
#‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø
#‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚†Ñ‚†Ñ‚£ø‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
#‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚£ø‚£ø‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø
#‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
#‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚†Ñ‚£ø
#‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚£ø‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚†Ñ‚£ø
#‚£ø‚£ø‚£ø‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚£ø
#‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚£ø‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø
#‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø
#‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø
#‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø

import datetime
from hikkatl.tl.types import Message
from hikkatl.tl.functions.messages import GetHistoryRequest
from hikkatl.tl.functions.users import GetFullUserRequest
from .. import loader, utils

@loader.tds
class LogDonModule(loader.Module):
    strings = {
        "name": "LogDon",
        "saved": "üóí –°–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ñ–∞–π–ª –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ.",
        "no_messages": "üö´ –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.",
    }

    @loader.command(ru_doc="<—á–∏—Å–ª–æ> - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ñ–∞–π–ª")
    async def logdoncmd(self, message: Message):
        args = utils.get_args_raw(message)
        if not args.isdigit():
            await utils.answer(message, "üö´ –£–∫–∞–∂–∏—Ç–µ —á–∏—Å–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.")
            return

        limit = int(args)
        if limit <= 0:
            await utils.answer(message, "üö´ –ß–∏—Å–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0.")
            return

        chat = await message.get_chat()
        all_messages = []
        offset_id = 0
        total_count = 0

        while True:
            history = await message.client(GetHistoryRequest(
                peer=chat,
                limit=min(100, limit - total_count),
                offset_id=offset_id,
                offset_date=None,
                add_offset=0,
                max_id=0,
                min_id=0,
                hash=0
            ))

            if not history.messages:
                break

            all_messages.extend(history.messages)
            total_count += len(history.messages)
            if total_count >= limit:
                break

            offset_id = history.messages[-1].id

        if not all_messages:
            await utils.answer(message, self.strings("no_messages"))
            return

        log_content = ""
        for msg in reversed(all_messages):
            user_id = msg.sender_id
            try:
                # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                user = await message.client(GetFullUserRequest(user_id))
                first_name = user.user.first_name or ""
                last_name = user.user.last_name or ""
                nickname = f"{first_name} {last_name}".strip()
            except Exception:
                nickname = ""

            date = msg.date.strftime("%d %b. %Y –≤ %H:%M")
            text = msg.raw_text
            log_content += f"User id: {user_id}, nickname: {nickname}, [{date}]\n{text}\n\n"

        filename = f"logdon_{chat.id}_{datetime.datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"
        with open(filename, "w", encoding="utf-8") as file:
            file.write(log_content)

        await message.client.send_file("me", filename, caption=self.strings("saved"))
        await utils.answer(message, self.strings("saved"))

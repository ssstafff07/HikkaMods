#‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø
#‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚£ø
#‚£ø‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
#‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø
#‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚†Ñ‚†Ñ‚£ø‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
#‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚£ø‚£ø‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø
#‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
#‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚†Ñ‚£ø
#‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚£ø‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚†Ñ‚£ø
#‚£ø‚£ø‚£ø‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚£ø
#‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚£ø‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø
#‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø
#‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø
#‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø

import datetime
from hikkatl.tl.types import Message
from hikkatl.tl.functions.messages import GetHistoryRequest, CreateChatRequest
from hikkatl.tl.functions.channels import CreateChannelRequest
from hikkatl.tl.functions.contacts import ResolveUsernameRequest
from .. import loader, utils

@loader.tds
class LogDonModule(loader.Module):
    strings = {
        "name": "LogDon",
        "saved": "üóí –°–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ñ–∞–π–ª –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –≥—Ä—É–ø–ø—É.",
        "no_messages": "üö´ –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.",
        "group_created": "‚úÖ –ì—Ä—É–ø–ø–∞ –¥–ª—è –ª–æ–≥–æ–≤ —Å–æ–∑–¥–∞–Ω–∞: {}",
        "group_exists": "‚úÖ –ì—Ä—É–ø–ø–∞ –¥–ª—è –ª–æ–≥–æ–≤ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: {}",
    }

    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        self.group_title = "LogDon Group"
        self.group = await self._ensure_group_exists()

    async def _ensure_group_exists(self):
        """–°–æ–∑–¥–∞–µ—Ç –≥—Ä—É–ø–ø—É –¥–ª—è –ª–æ–≥–æ–≤, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."""
        try:
            # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –≥—Ä—É–ø–ø—É –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
            resolved = await self.client(ResolveUsernameRequest(self.group_title))
            return resolved.chats[0]
        except Exception:
            # –ï—Å–ª–∏ –≥—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é
            created = await self.client(CreateChannelRequest(
                title=self.group_title,
                about="–ì—Ä—É–ø–ø–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π",
                megagroup=True,
            ))
            return created.chats[0]

    @loader.command(ru_doc="<—á–∏—Å–ª–æ> - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ñ–∞–π–ª")
    async def ldcmd(self, message: Message):
        args = utils.get_args_raw(message)
        if not args.isdigit():
            await utils.answer(message, "üö´ –£–∫–∞–∂–∏—Ç–µ —á–∏—Å–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.")
            return

        limit = int(args)
        if limit <= 0:
            await utils.answer(message, "üö´ –ß–∏—Å–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0.")
            return

        chat = await message.get_chat()
        all_messages = []
        offset_id = 0
        total_count = 0

        while True:
            history = await self.client(GetHistoryRequest(
                peer=chat,
                limit=min(100, limit - total_count),
                offset_id=offset_id,
                offset_date=None,
                add_offset=0,
                max_id=0,
                min_id=0,
                hash=0
            ))

            if not history.messages:
                break

            all_messages.extend(history.messages)
            total_count += len(history.messages)
            if total_count >= limit:
                break

            offset_id = history.messages[-1].id

        if not all_messages:
            await utils.answer(message, self.strings("no_messages"))
            return

        log_content = ""
        for msg in reversed(all_messages):
            user_id = msg.sender_id
            date = msg.date.strftime("%d %b. %Y –≤ %H:%M")
            text = msg.raw_text
            log_content += f"User id: tg://user?id={user_id}, [{date}]\n{text}\n\n"

        filename = f"logdon_{chat.id}_{datetime.datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"
        with open(filename, "w", encoding="utf-8") as file:
            file.write(log_content)

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –≤ –≥—Ä—É–ø–ø—É
        await self.client.send_file(self.group, filename, caption=self.strings("saved"))
        await utils.answer(message, self.strings("saved"))

import datetime
from hikkatl.tl.types import Message
from hikkatl.tl.functions.messages import GetHistoryRequest
from .. import loader, utils

@loader.tds
class LogDonModule(loader.Module):
    strings = {
        "name": "LogDon",
        "saved": "üóí –°–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ñ–∞–π–ª –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ.",
        "no_messages": "üö´ –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.",
    }
#This mod will show your level of strength.
#Developer's telegram @ZZZOOOVVV2007
#‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø
#‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚£ø
#‚£ø‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
#‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø
#‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚†Ñ‚†Ñ‚£ø‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
#‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚£ø‚£ø‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø
#‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø
#‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚†Ñ‚£ø
#‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚£ø‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚†Ñ‚£ø
#‚£ø‚£ø‚£ø‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚£ø
#‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚£ø‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø
#‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø
#‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø
#‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚†Ñ‚†Ñ‚†Ñ‚£ø‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø
#‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚†Ñ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø

import datetime
from hikkatl.tl.types import Message
from hikkatl.tl.functions.messages import GetHistoryRequest
from .. import loader, utils

@loader.tds
class LogDonModule(loader.Module):
    strings = {
        "name": "LogDon",
        "saved": "üóí –°–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ñ–∞–π–ª –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ.",
        "no_messages": "üö´ –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.",
    }

    @loader.command(ru_doc="<—á–∏—Å–ª–æ> - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ñ–∞–π–ª")
    async def logdoncmd(self, message: Message):
        args = utils.get_args_raw(message)
        if not args.isdigit():
            await utils.answer(message, "üö´ –£–∫–∞–∂–∏—Ç–µ —á–∏—Å–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.")
            return

        limit = int(args)
        if limit <= 0:
            await utils.answer(message, "üö´ –ß–∏—Å–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0.")
            return

        chat = await message.get_chat()
        history = await message.client(GetHistoryRequest(
            peer=chat,
            limit=limit,
            offset_date=None,
            offset_id=0,
            max_id=0,
            min_id=0,
            add_offset=0,
            hash=0
        ))

        if not history.messages:
            await utils.answer(message, self.strings("no_messages"))
            return

        log_content = ""
        for msg in reversed(history.messages):
            user_id = msg.sender_id
            date = msg.date.strftime("%d %b. %Y –≤ %H:%M")
            text = msg.raw_text
            log_content += f"User id: {user_id}, [{date}]\n{text}\n\n"

        filename = f"logdon_{chat.id}_{datetime.datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"
        with open(filename, "w", encoding="utf-8") as file:
            file.write(log_content)

        await message.client.send_file("me", filename, caption=self.strings("saved"))
        await utils.answer(message, self.strings("saved"))

import os
import random
from .. import loader, utils
from pytube import YouTube
from TikTokApi import TikTokApi

@loader.tds
class VideoLoader(loader.Module):
    strings = {
        "name": "VideoLoader",
        "youtube_downloaded": "üé• –í–∏–¥–µ–æ —Å YouTube —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω–æ: {}",
        "tiktok_downloaded": "üé• –í–∏–¥–µ–æ —Å TikTok —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω–æ: {}",
        "error": "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –≤–∏–¥–µ–æ.",
        "invalid_url": "‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Å—ã–ª–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ —Å YouTube –∏–ª–∏ TikTok.",
        "no_url": "‚ùå –£–∫–∞–∂–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ."
    }

    def __init__(self):
        self.name = self.strings["name"]

    @loader.command(ru_doc="–°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ —Å YouTube")
    async def ydcmd(self, message):
        """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤–∏–¥–µ–æ —Å YouTube."""
        args = utils.get_args_raw(message)
        if not args:
            await message.edit(self.strings["no_url"])
            return

        if "youtube.com" in args or "youtu.be" in args:
            await self.download_youtube_video(message, args)
        else:
            await message.edit(self.strings["invalid_url"])

    @loader.command(ru_doc="–°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ —Å TikTok")
    async def tdcmd(self, message):
        """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤–∏–¥–µ–æ —Å TikTok."""
        args = utils.get_args_raw(message)
        if not args:
            await message.edit(self.strings["no_url"])
            return

        if "tiktok.com" in args:
            await self.download_tiktok_video(message, args)
        else:
            await message.edit(self.strings["invalid_url"])

    async def download_youtube_video(self, message, url):
        try:
            yt = YouTube(url)
            video = yt.streams.filter(progressive=True, file_extension='mp4').first()
            if not video:
                await message.edit("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–æ—Ç–æ–∫ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.")
                return

            output_path = video.download(output_path="downloads")
            await message.edit(self.strings["youtube_downloaded"].format(output_path))
        except Exception as e:
            await message.edit(self.strings["error"])
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –≤–∏–¥–µ–æ —Å YouTube: {e}")

    async def download_tiktok_video(self, message, url):
        try:
            api = TikTokApi()
            video_info = api.get_video_by_url(url)
            if not video_info:
                await message.edit("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–∏–¥–µ–æ —Å TikTok.")
                return

            output_path = os.path.join("downloads", f"tiktok_video_{random.randint(1, 1000)}.mp4")
            with open(output_path, "wb") as f:
                f.write(video_info)

            await message.edit(self.strings["tiktok_downloaded"].format(output_path))
        except Exception as e:
            await message.edit(self.strings["error"])
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –≤–∏–¥–µ–æ —Å TikTok: {e}")
